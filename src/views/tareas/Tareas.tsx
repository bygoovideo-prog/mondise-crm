import React,{useEffect,useMemo,useState} from 'react'
import { supabase } from '../../supabaseClient'
const blank:any={titulo:'',descripcion:'',fecha:'',estado:'Pendiente',departamento:'comercial'}
export default function Tareas(){const [items,setItems]=useState<any[]>([]);const [q,setQ]=useState('');const [estado,setEstado]=useState('');const [form,setForm]=useState<any>(blank);const load=async()=>{const {data}=await supabase.from('tareas').select('*').order('fecha',{ascending:false}).limit(200);setItems((data||[]) as any)};useEffect(()=>{load();const ch=supabase.channel('tareas-realtime').on('postgres_changes',{event:'*',schema:'public',table:'tareas'},_p=>load()).subscribe();return()=>{supabase.removeChannel(ch)}},[]);const filtered=useMemo(()=>items.filter(i=>!estado or i.estado===estado).filter(i=>JSON.stringify(i).toLowerCase().includes(q.toLowerCase())),[items,estado,q]);const save=async()=>{if(!form.titulo)return alert('Título es requerido');if(form.id){await supabase.from('tareas').update(form).eq('id',form.id)}else{const {data:user}=await supabase.auth.getUser();await supabase.from('tareas').insert({..form, creador:user.user?.id, asignado_a:form.asignado_a||user.user?.id} as any)};setForm({...blank});await load()};const del=async(id:string)=>{if(!confirm('¿Borrar tarea?'))return;await supabase.from('tareas').delete().eq('id',id);await load()};return(<section style={{marginTop:16}}><div style={{display:'flex',gap:8,alignItems:'center',flexWrap:'wrap'}}><input placeholder='Buscar tarea...' value={q} onChange={e=>setQ(e.target.value)} style={{minWidth:220}}/><select value={estado} onChange={e=>setEstado(e.target.value)}><option value=''>Todas</option><option>Pendiente</option><option>En curso</option><option>Hecho</option></select><button onClick={()=>setForm({...blank})} className='btn' style={{marginLeft:'auto'}}>Nueva tarea</button></div><Editor form={form} setForm={setForm} onSave={save} onCancel={()=>setForm({...blank})}/><div style={{display:'grid',gridTemplateColumns:'repeat(3, minmax(0,1fr))',gap:12,marginTop:12}}>{filtered.map(t=>(<div key={t.id} className='card'><div style={{display:'flex',justifyContent:'space-between'}}><strong>{t.titulo}</strong><span style={{background:'#eef',padding:'2px 8px',borderRadius:12}}>{t.estado}</span></div><small style={{color:'#666'}}>{t.fecha||'Sin fecha'} · {t.departamento}</small><div style={{fontSize:14}}>{t.descripcion}</div><div style={{display:'flex',gap:8,justifyContent:'flex-end',marginTop:8}}><button onClick={()=>setForm(t)} className='btn secondary'>Editar</button><button onClick={()=>del(t.id)} className='btn secondary' style={{color:'#b91c1c'}}>Borrar</button></div></div>))}</div></section>)}
